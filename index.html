<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор термопары типа K</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, button { width: 100%; margin-top: 5px; padding: 8px; box-sizing: border-box; }
    .row { margin-bottom: 15px; }
    .result { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
    hr { margin: 30px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Калькулятор термопары (тип K)</h1>

    <label for="scale">Шкала температуры:</label>
    <select id="scale" onchange="convertScale()">
      <option value="C">Цельсий</option>
      <option value="K">Кельвин</option>
      <option value="F">Фаренгейт</option>
    </select>

    <label for="mode">Режим:</label>
    <select id="mode" onchange="switchMode()">
      <option value="t-to-mv">Температура → ТЭДС</option>
      <option value="mv-to-t">ТЭДС → Температура</option>
    </select>

    <div id="t-to-mv-fields">
      <label>Температура измерительного конца:</label>
      <input type="number" id="t1" value="100">

      <label>Температура свободного конца:</label>
      <input type="number" id="t2" value="25">
    </div>

    <div id="mv-to-t-fields" style="display:none">
      <label>ТЭДС (мВ):</label>
      <input type="number" id="mv" value="2.5">

      <label>Температура свободного конца:</label>
      <input type="number" id="cold-junction" value="25">
    </div>

    <button onclick="calculate()">Рассчитать</button>
    <div class="result" id="output"></div>

    <hr>

    <h2>Экспорт таблицы</h2>
    <label>Режим:</label>
    <select id="table-mode">
      <option value="t-to-mv">Температура → ТЭДС</option>
      <option value="mv-to-t">ТЭДС → Температура</option>
    </select>

    <label>От:</label>
    <input type="number" id="range-from" value="0">

    <label>До:</label>
    <input type="number" id="range-to" value="100">

    <label>Шаг:</label>
    <input type="number" id="range-step" value="10">

    <label>Температура свободного конца:</label>
    <input type="number" id="range-cj" value="25">

    <button onclick="generateCSV()">Скачать CSV</button>
  </div>

  <script>
    let currentScale = 'C';

    function switchMode() {
      const mode = document.getElementById('mode').value;
      document.getElementById('t-to-mv-fields').style.display = mode === 't-to-mv' ? 'block' : 'none';
      document.getElementById('mv-to-t-fields').style.display = mode === 'mv-to-t' ? 'block' : 'none';
      document.getElementById('output').innerText = '';
    }

    function toCelsius(val, scale) {
      if (scale === 'K') return val - 273.15;
      if (scale === 'F') return (val - 32) * 5 / 9;
      return val;
    }

    function fromCelsius(val, scale) {
      if (scale === 'K') return val + 273.15;
      if (scale === 'F') return val * 9 / 5 + 32;
      return val;
    }

    function convertScale() {
      const newScale = document.getElementById('scale').value;
      const fields = ['t1', 't2', 'cold-junction', 'range-cj'];
      fields.forEach(id => {
        const input = document.getElementById(id);
        if (input.value !== '') {
          const valueC = toCelsius(parseFloat(input.value), currentScale);
          input.value = fromCelsius(valueC, newScale).toFixed(2);
        }
      });
      currentScale = newScale;
    }

    function typeK_TtoMV(t) {
      if (t < -270 || t > 1372) return NaN;
      let mv = 0;
      if (t < 0) {
        const c = [0, 3.9450128025e-2, 2.3622373598e-5, -3.2858906784e-7, -4.9904828777e-9, -6.7509059173e-11, -5.7410327428e-13, -3.1088872894e-15, -1.0451609365e-17, -1.9889266878e-20, -1.6322697486e-23];
        for (let i = 0; i < c.length; i++) mv += c[i] * Math.pow(t, i);
      } else {
        const c = [-1.7600413686e-2, 3.8921204975e-2, 1.8558770032e-5, -9.9457928974e-8, 3.1840945719e-10, -5.6072844889e-13, 5.6075059059e-16, -3.2020720003e-19, 9.7151147152e-23, -1.2104721275e-26];
        for (let i = 0; i < c.length; i++) mv += c[i] * Math.pow(t, i);
        mv += 1.185976e-1 * Math.exp(-1.183432e-4 * Math.pow(t - 126.9686, 2));
      }
      return mv;
    }

    function typeK_MVtoT(mv) {
      if (mv < -5.891 || mv > 54.886) return NaN;
      let t = 0;
      if (mv < 0) {
        const c = [0, 2.5173462e+1, -1.1662878, -1.0833638, -8.9773540e-1, -3.7342377e-1, -8.6632643e-2, -1.0450598e-2, -5.1920577e-4];
        for (let i = 0; i < c.length; i++) t += c[i] * Math.pow(mv, i);
      } else if (mv <= 20.644) {
        const c = [0, 2.508355e+1, 7.860106e-2, -2.503131e-1, 8.315270e-2, -1.228034e-2, 9.804036e-4, -4.413030e-5, 1.057734e-6, -1.052755e-8];
        for (let i = 0; i < c.length; i++) t += c[i] * Math.pow(mv, i);
      } else {
        const c = [-1.318058e+2, 4.830222e+1, -1.646031, 5.464731e-2, -9.650715e-4, 8.802193e-6, -3.110810e-8];
        for (let i = 0; i < c.length; i++) t += c[i] * Math.pow(mv, i);
      }
      return t;
    }

    function calculate() {
      const mode = document.getElementById('mode').value;
      const scale = currentScale;
      let result = '';

      if (mode === 't-to-mv') {
        const t1 = toCelsius(parseFloat(document.getElementById('t1').value), scale);
        const t2 = toCelsius(parseFloat(document.getElementById('t2').value), scale);
        const mv = typeK_TtoMV(t1) - typeK_TtoMV(t2);
        result = isNaN(mv) ? 'Ошибка: температура вне диапазона' : `ТЭДС: ${mv.toFixed(4)} мВ`;
      } else {
        const mv = parseFloat(document.getElementById('mv').value);
        const cj = toCelsius(parseFloat(document.getElementById('cold-junction').value), scale);
        const mv_total = mv + typeK_TtoMV(cj);
        const t = typeK_MVtoT(mv_total);
        result = isNaN(t) ? 'Ошибка: ЭДС вне диапазона' : `Температура горячего конца: ${fromCelsius(t, scale).toFixed(2)} ${scale}`;
      }

      document.getElementById('output').innerText = result;
    }

    function generateCSV() {
      const mode = document.getElementById('table-mode').value;
      const from = parseFloat(document.getElementById('range-from').value);
      const to = parseFloat(document.getElementById('range-to').value);
      const step = parseFloat(document.getElementById('range-step').value);
      const cj = toCelsius(parseFloat(document.getElementById('range-cj').value), currentScale);
      const rows = [];
      const BOM = '\uFEFF';

      if (mode === 't-to-mv') {
        rows.push("Температура (°C),ТЭДС (мВ)");
        for (let t = from; t <= to; t += step) {
          const mv = typeK_TtoMV(t) - typeK_TtoMV(cj);
          if (!isNaN(mv)) rows.push(`${t.toFixed(2)},${mv.toFixed(5)}`);
        }
      } else {
        rows.push("ТЭДС (мВ),Температура (°C)");
        for (let mv = from; mv <= to; mv += step) {
          const total_mv = mv + typeK_TtoMV(cj);
          const t = typeK_MVtoT(total_mv);
          if (!isNaN(t)) rows.push(`${mv.toFixed(4)},${t.toFixed(2)}`);
        }
      }

      const csvContent = BOM + rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "thermocouple_data.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
